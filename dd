version: "3"
services:
  datastore-reader:
    image: openslides-datastore-reader-dev
    volumes:
      - ./openslides-datastore-service/shared/shared:/app/shared
      - ./openslides-datastore-service/reader/reader:/app/reader
    depends_on:
      - otel-collector
  datastore-writer:
    image: openslides-datastore-writer-dev
    volumes:
      - ./openslides-datastore-service/shared/shared:/app/shared
      - ./openslides-datastore-service/writer/writer:/app/writer
      - ./openslides-datastore-service/cli:/app/cli
    environment:
      - DATASTORE_ENABLE_DEV_ENVIRONMENT=1
      - COMMAND=create_initial_data
      - DATASTORE_INITIAL_DATA_FILE=https://raw.githubusercontent.com/OpenSlides/OpenSlides/openslides4-dev/docs/example-data.json
  client:
    image: openslides-client-dev
    volumes:
      - ./openslides-client/client/src:/app/src
  backend:
    image: openslides-backend-dev
    volumes:
      - ./openslides-backend/openslides_backend:/app/openslides_backend
    depends_on:
      - otel-collector
  autoupdate:
    image: openslides-autoupdate-dev
    volumes:
      - ./openslides-autoupdate-service/cmd:/root/cmd
      - ./openslides-autoupdate-service/internal:/root/internal
  auth:
    image: openslides-auth-dev
    volumes:
      - ./openslides-auth-service/auth/src:/app/src
  media:
    image: openslides-media-dev
    volumes:
      - ./openslides-media-service/src:/app/src
  haproxy:
    image: openslides-haproxy-dev
    volumes:
      - ./haproxy/src:/usr/local/etc/haproxy


  jaeger-all-in-one:
    image: jaegertracing/all-in-one:latest
    ports:
      - "16686:16686"
    #  - "14268"
    #  - "14250"

  # Collector
  otel-collector:
    image: otel/opentelemetry-collector-dev:latest
    command: ["--config=/etc/otel-collector-config.yaml", "--log-level=DEBUG"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - "9464"
    #  - "1888:1888"   # pprof extension
    #  - "8888:8888"   # Prometheus metrics exposed by the collector
    #  - "8889:8889"   # Prometheus exporter metrics
    #  - "13133:13133" # health_check extension
    #  - "55678"       # OpenCensus receiver
    #  - "55680:55680" # OTLP traces
    #  - "55681:55681" # OTLP metrics
    #  - "55670:55679" # zpages extension
    depends_on:
      - jaeger-all-in-one

  # Agent
  #otel-agent:
  #  image: otel/opentelemetry-collector-dev:latest
  #  command: ["--config=/etc/otel-agent-config.yaml"]
  #  volumes:
  #    - ./otel-agent-config.yaml:/etc/otel-agent-config.yaml
  #  ports:
  #    - "1777:1777"   # pprof extension
  #    - "8887:8888"   # Prometheus metrics exposed by the agent
  #    - "14268"       # Jaeger receiver
  #    - "55678"       # OpenCensus receiver
  #    - "55679:55679" # zpages extension
  #    - "13133"       # health_check
  #  depends_on:
  #    - otel-collector

  # Synthetic load generators
  #jaeger-emitter:
  #  image: omnition/synthetic-load-generator:1.0.25
  #  environment:
  #    - JAEGER_COLLECTOR_URL=http://otel-agent:14268
  #  depends_on:
  #    - otel-agent

  #zipkin-emitter:
  #  image: omnition/synthetic-load-generator:1.0.25
  #  environment:
  #    - ZIPKINV2_JSON_URL=http://otel-agent:9411/api/v2/spans
  #  depends_on:
  #    - otel-agent

  #metrics-load-generator:
  #  image: golang:1.12.7
  #  volumes:
  #    - ./app/main.go:/usr/src/main.go
  #  environment:
  #    - GO111MODULE=on
  #    - OTEL_AGENT_ENDPOINT=otel-agent:55678
  #  command: ["bash", "-c", "go run /usr/src/main.go"]
  #  depends_on:
  #    - otel-agent

  prometheus:
    image: prom/prometheus:latest
    command: --config.file=/etc/prometheus/prometheus.yml --log.level=debug
    volumes:
      - ./prometheus.yaml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    depends_on:
      - otel-collector
