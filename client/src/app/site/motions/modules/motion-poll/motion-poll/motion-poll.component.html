<div class="poll-preview-wrapper" *ngIf="poll && showPoll()">
    <!-- Poll Infos -->
    <div class="poll-title-wrapper">
        <!-- Title -->
        <a class="poll-title" [routerLink]="pollLink">
            {{ poll.title }}
        </a>

        <!-- Dot Menu -->
        <span class="poll-title-actions" *osPerms="'motions.can_manage_polls'">
            <button mat-icon-button [matMenuTriggerFor]="pollDetailMenu">
                <mat-icon class="small-icon">more_horiz</mat-icon>
            </button>
        </span>

        <!-- State chip -->
        <div class="poll-properties" *osPerms="'motions.can_manage_polls'">
            <div *ngIf="pollService.isElectronicVotingEnabled && poll.type !== 'analog'">
                {{ poll.typeVerbose | translate }}
            </div>

            <mat-chip
                disableRipple
                class="poll-state active"
                [matMenuTriggerFor]="triggerMenu"
                [ngClass]="poll.stateVerbose.toLowerCase()"
            >
                {{ poll.stateVerbose }}
            </mat-chip>
        </div>
    </div>

    <!-- Results -->
    <ng-container *ngIf="poll && !poll.stateHasVotes && poll.type !== 'analog'; else votingResult">
        <os-motion-poll-vote [poll]="poll"></os-motion-poll-vote>
    </ng-container>
</div>

<ng-template #votingResult>
    <div [routerLink]="pollLink">
        <ng-container
            [ngTemplateOutlet]="poll.hasVotes && poll.stateHasVotes ? viewTemplate : emptyTemplate"
        ></ng-container>
    </div>
</ng-template>

<ng-template #viewTemplate>
    <div class="poll-chart-wrapper">
        <!-- empty helper div to center the grid wrapper -->
        <div></div>
        <div class="doughnut-chart">
            <os-charts *ngIf="showChart" [type]="'doughnut'" [data]="chartDataSubject" [showLegend]="false"> </os-charts>
        </div>
        <div class="vote-legend">
            <div class="votes-yes" *ngIf="isVoteDocumented(voteYes)">
                <os-icon-container icon="thumb_up" size="large">
                    {{ voteYes | parsePollNumber }}
                </os-icon-container>
            </div>
            <div class="votes-no" *ngIf="isVoteDocumented(voteNo)">
                <os-icon-container icon="thumb_down" size="large">
                    {{ voteNo | parsePollNumber }}
                </os-icon-container>
            </div>
            <div class="votes-abstain" *ngIf="isVoteDocumented(voteAbstain)">
                <os-icon-container icon="trip_origin" size="large">
                    {{ voteAbstain | parsePollNumber }}
                </os-icon-container>
            </div>
        </div>
    </div>
    <div class="poll-detail-button-wrapper" *ngIf="poll.type !== 'analog'">
        <button mat-button [routerLink]="pollLink">
            {{ 'Single Votes' | translate }}
        </button>
    </div>
</ng-template>

<ng-template #emptyTemplate>
    <div *osPerms="'motions.can_manage_polls'">
        {{ 'An empty poll - you have to enter votes.' | translate }}
    </div>
</ng-template>

<!-- More Menu -->
<mat-menu #pollDetailMenu="matMenu">
    <os-projector-button [menuItem]="true" [object]="poll" *osPerms="'core.can_manage_projector'"></os-projector-button>
    <button *osPerms="'motions.can_manage_polls'" mat-menu-item (click)="openDialog()">
        <mat-icon>edit</mat-icon>
        <span translate>Edit</span>
    </button>
    <button mat-menu-item (click)="downloadPdf()">
        <mat-icon>picture_as_pdf</mat-icon>
        <span translate>PDF</span>
    </button>
    <div *osPerms="'motions.can_manage_polls'">
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="deletePoll()">
            <mat-icon color="warn">delete</mat-icon>
            <span translate>Delete</span>
        </button>
    </div>
</mat-menu>

<!-- Select state menu -->
<mat-menu #triggerMenu="matMenu">
    <ng-container *ngIf="poll">
        <button mat-menu-item (click)="changeState(state.value)" *ngFor="let state of poll.nextStates | keyvalue">
            <span translate>{{ state.key }}</span>
        </button>
    </ng-container>
</mat-menu>
